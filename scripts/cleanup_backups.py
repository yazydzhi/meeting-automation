#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π —Ñ–∞–π–ª–æ–≤ —Å—Ç–∞—Ç—É—Å–∞.
"""

import os
import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–æ–≤
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from src.config_manager import ConfigManager
except ImportError as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
    print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞")
    sys.exit(1)


def cleanup_backup_files(root_path: str) -> int:
    """–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Ñ–∞–π–ª–æ–≤."""
    backup_count = 0
    
    for root, dirs, files in os.walk(root_path):
        for file in files:
            if file.endswith(".backup"):
                backup_path = os.path.join(root, file)
                try:
                    os.remove(backup_path)
                    print(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: {backup_path}")
                    backup_count += 1
                except Exception as e:
                    print(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è {backup_path}: {e}")
    
    return backup_count


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è."""
    print("üóëÔ∏è –°–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π")
    print("=" * 40)
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    try:
        config_manager = ConfigManager()
        print("‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
        sys.exit(1)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    if not config_manager.validate_config():
        print("‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞")
        sys.exit(1)
    
    total_backup_count = 0
    
    # –û—á–∏—â–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –≤ –ª–∏—á–Ω–æ–º –∞–∫–∫–∞—É–Ω—Ç–µ
    if config_manager.is_personal_enabled():
        personal_config = config_manager.get_personal_config()
        personal_folder = personal_config.get('local_drive_root')
        
        if personal_folder and os.path.exists(personal_folder):
            print(f"\nüë§ –û—á–∏—Å—Ç–∫–∞ –ª–∏—á–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞: {personal_folder}")
            backup_count = cleanup_backup_files(personal_folder)
            total_backup_count += backup_count
            print(f"‚úÖ –£–¥–∞–ª–µ–Ω–æ {backup_count} —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π")
    
    # –û—á–∏—â–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –≤ —Ä–∞–±–æ—á–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ
    if config_manager.is_work_enabled():
        work_config = config_manager.get_work_config()
        work_folder = work_config.get('local_drive_root')
        
        if work_folder and os.path.exists(work_folder):
            print(f"\nüè¢ –û—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞: {work_folder}")
            backup_count = cleanup_backup_files(work_folder)
            total_backup_count += backup_count
            print(f"‚úÖ –£–¥–∞–ª–µ–Ω–æ {backup_count} —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π")
    
    print(f"\nüéâ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í—Å–µ–≥–æ —É–¥–∞–ª–µ–Ω–æ: {total_backup_count} —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π")


if __name__ == "__main__":
    main()
