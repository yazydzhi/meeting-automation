#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π —Å–æ–±—ã—Ç–∏–π.
"""

import os
import sys
from dotenv import load_dotenv

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.event_exclusions import EventExclusionManager, ExclusionType

def test_exclusions():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º—É –∏—Å–∫–ª—é—á–µ–Ω–∏–π."""
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    load_dotenv()
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π —Å–æ–±—ã—Ç–∏–π...")
    print("=" * 60)
    
    # –°–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    exclusion_manager = EventExclusionManager(config_manager=None)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats = exclusion_manager.get_exclusion_stats()
    print(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π:")
    print(f"  üìÑ –í—Å–µ–≥–æ: {stats['total']}")
    print(f"  üë§ –õ–∏—á–Ω—ã–µ: {stats['personal']}")
    print(f"  üîß –†–∞–±–æ—á–∏–µ: {stats['work']}")
    print(f"  üîÑ –û–±—â–∏–µ: {stats['both']}")
    print(f"  üî§ –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {stats['keywords']}")
    print(f"  üìù –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è: {stats['regex']}")
    print()
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
    test_events = [
        # –õ–∏—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
        ("–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –º–∞–º—ã", "personal"),
        ("–î–µ–ª–∞ –ø–æ –¥–æ–º—É", "personal"),
        ("–õ–∏—á–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞", "personal"),
        ("–û—Ç–ø—É—Å–∫ –≤ –≥–æ—Ä–∞—Ö", "personal"),
        ("–ü—Ä–∞–∑–¥–Ω–∏–∫ —Å–µ–º—å–∏", "personal"),
        ("–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å", "personal"),
        ("–û—Ç–¥—ã—Ö –Ω–∞ –¥–∞—á–µ", "personal"),
        ("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–æ–∫—É–ø–∫–∞—Ö", "personal"),
        ("Personal meeting", "personal"),
        
        # –†–∞–±–æ—á–∏–µ —Å–æ–±—ã—Ç–∏—è
        ("–û–±–µ–¥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º", "work"),
        ("–ü–µ—Ä–µ—Ä—ã–≤ –Ω–∞ –∫–æ—Ñ–µ", "work"),
        ("–û—Ç–≥—É–ª –ø–æ –±–æ–ª–µ–∑–Ω–∏", "work"),
        ("–ë–æ–ª—å–Ω–∏—á–Ω—ã–π –ª–∏—Å—Ç", "work"),
        ("–û—Ç–ø—É—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", "work"),
        ("–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –¥–µ–Ω—å", "work"),
        ("–í—ã—Ö–æ–¥–Ω–æ–π –≤ –æ—Ñ–∏—Å–µ", "work"),
        ("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤—Å—Ç—Ä–µ—á–µ", "work"),
        ("Reminder about deadline", "work"),
        ("–ü–µ—Ä–µ–∫—É—Ä —Å –∫–æ–ª–ª–µ–≥–∞–º–∏", "work"),
        ("–ö–æ—Ñ–µ-–±—Ä–µ–π–∫", "work"),
        
        # –°–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –¥–æ–ª–∂–Ω—ã –∏—Å–∫–ª—é—á–∞—Ç—å—Å—è
        ("–í–∞–∂–Ω–∞—è —Ä–∞–±–æ—á–∞—è –≤—Å—Ç—Ä–µ—á–∞", "work"),
        ("–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞", "work"),
        ("–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∏–Ω—Ç–∞", "work"),
        ("–õ–∏—á–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", "personal"),
        ("–í—Å—Ç—Ä–µ—á–∞ —Å –¥—Ä—É–∑—å—è–º–∏", "personal"),
        ("–í–∞–∂–Ω–æ–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ", "personal"),
    ]
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π:")
    print("-" * 60)
    
    excluded_count = 0
    included_count = 0
    
    for event_title, account_type in test_events:
        should_exclude = exclusion_manager.should_exclude_event(event_title, account_type)
        
        if should_exclude:
            print(f"üö´ –ò–°–ö–õ–Æ–ß–ï–ù–û: {event_title} ({account_type})")
            excluded_count += 1
        else:
            print(f"‚úÖ –í–ö–õ–Æ–ß–ï–ù–û: {event_title} ({account_type})")
            included_count += 1
    
    print()
    print("üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:")
    print(f"  üö´ –ò—Å–∫–ª—é—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–π: {excluded_count}")
    print(f"  ‚úÖ –í–∫–ª—é—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–π: {included_count}")
    print(f"  üìÑ –í—Å–µ–≥–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: {len(test_events)}")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    print(f"\nüîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π:")
    print("-" * 60)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    test_regex = ".*[–¢—Ç]–µ—Å—Ç.*"
    success = exclusion_manager.add_exclusion("both", ExclusionType.REGEX, test_regex)
    
    if success:
        print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ: {test_regex}")
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
        test_title = "–¢–µ—Å—Ç–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞"
        should_exclude = exclusion_manager.should_exclude_event(test_title, "work")
        
        if should_exclude:
            print(f"‚úÖ –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: '{test_title}' –∏—Å–∫–ª—é—á–µ–Ω–æ")
        else:
            print(f"‚ùå –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: '{test_title}' –Ω–µ –∏—Å–∫–ª—é—á–µ–Ω–æ")
        
        # –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
        exclusion_manager.remove_exclusion("both", ExclusionType.REGEX, test_regex)
        print(f"üóëÔ∏è –¢–µ—Å—Ç–æ–≤–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
    print(f"\nüìã –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è:")
    print("-" * 60)
    print(str(exclusion_manager))
    
    return True

if __name__ == "__main__":
    try:
        success = test_exclusions()
        
        if success:
            print("\n‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
        else:
            print("\n‚ùå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —Å –æ—à–∏–±–∫–∞–º–∏!")
            sys.exit(1)
            
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        sys.exit(1)
