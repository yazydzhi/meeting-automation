#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram.
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ src –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

try:
    from config_manager import ConfigManager
    from telegram_api import TelegramAPI
except ImportError as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
    print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –º–æ–¥—É–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã")
    sys.exit(1)


def test_telegram_connection():
    """–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Telegram API."""
    print("üîç –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Telegram API")
    print("=" * 50)
    
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        config_manager = ConfigManager()
        telegram_config = config_manager.get_telegram_config()
        
        if not telegram_config.get('bot_token') or not telegram_config.get('chat_id'):
            print("‚ùå Telegram –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
            return False
        
        print(f"‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
        print(f"   Bot Token: {'*' * 10 + telegram_config['bot_token'][-4:] if telegram_config['bot_token'] else '–ù–ï–¢'}")
        print(f"   Chat ID: {telegram_config['chat_id']}")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram API
        telegram_api = TelegramAPI(telegram_config)
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        if telegram_api.test_connection():
            print("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Telegram —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
            return True
        else:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Telegram")
            return False
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        return False


def test_message_sending():
    """–¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π."""
    print("\nüì± –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π")
    print("=" * 50)
    
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        config_manager = ConfigManager()
        telegram_config = config_manager.get_telegram_config()
        
        if not telegram_config.get('bot_token') or not telegram_config.get('chat_id'):
            print("‚ùå Telegram –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
            return False
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram API
        telegram_api = TelegramAPI(telegram_config)
        
        # –¢–µ—Å—Ç 1: –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        print("üìù –¢–µ—Å—Ç 1: –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
        simple_message = "üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –≤—Å—Ç—Ä–µ—á"
        if telegram_api.send_message(simple_message):
            print("‚úÖ –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
        else:
            print("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–æ—Å—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è")
            return False
        
        # –¢–µ—Å—Ç 2: HTML-—Ä–∞–∑–º–µ—Ç–∫–∞
        print("\nüìù –¢–µ—Å—Ç 2: HTML-—Ä–∞–∑–º–µ—Ç–∫–∞")
        html_message = """
ü§ñ <b>–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç —Å–∏—Å—Ç–µ–º—ã</b>

üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>
   ‚úÖ <b>–ö–∞–ª–µ–Ω–¥–∞—Ä—å:</b> –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 5 —Å–æ–±—ã—Ç–∏–π
   ‚úÖ <b>–ú–µ–¥–∏–∞:</b> –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 2 —Ñ–∞–π–ª–∞
   ‚úÖ <b>Notion:</b> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ 3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã

üéØ <b>–°—Ç–∞—Ç—É—Å:</b> –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ
        """.strip()
        
        if telegram_api.send_message(html_message, parse_mode="HTML"):
            print("‚úÖ HTML-—Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
        else:
            print("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ HTML-—Å–æ–æ–±—â–µ–Ω–∏—è")
            return False
        
        # –¢–µ—Å—Ç 3: –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
        print("\nüìù –¢–µ—Å—Ç 3: –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç")
        detailed_message = """
ü§ñ <b>–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –≤—Å—Ç—Ä–µ—á</b>

‚è∞ <b>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</b> 2025-08-27 15:30:00
üîÑ <b>–¶–∏–∫–ª:</b> #42

üìã <b>–°—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–æ–≤:</b>
   üë§ <b>–õ–∏—á–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç:</b> ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω
   üè¢ <b>–†–∞–±–æ—á–∏–π –∞–∫–∫–∞—É–Ω—Ç:</b> ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω

üìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</b>
üìÖ <b>–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:</b>
   üë§ <b>–õ–∏—á–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å:</b> ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 3 –∏–∑ 5 —Å–æ–±—ã—Ç–∏–π
   üè¢ <b>–†–∞–±–æ—á–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å:</b> ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 2 –∏–∑ 3 —Å–æ–±—ã—Ç–∏–π

üé¨ <b>–ú–µ–¥–∏–∞ —Ñ–∞–π–ª—ã:</b>
   ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 2 —Ñ–∞–π–ª–æ–≤
   üìè –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: 156.7 MB

üé§ <b>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:</b>
   ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 1 —Ñ–∞–π–ª–æ–≤
   ‚è±Ô∏è –û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 45:30

üìù <b>Notion —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:</b>
   ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ 5 —Å—Ç—Ä–∞–Ω–∏—Ü
   üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ: 2 —Å—Ç—Ä–∞–Ω–∏—Ü

‚è±Ô∏è <b>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ü–∏–∫–ª–∞:</b> 12.45 —Å–µ–∫—É–Ω–¥

üéØ <b>–°—Ç–∞—Ç—É—Å:</b> ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ
        """.strip()
        
        if telegram_api.send_message(detailed_message, parse_mode="HTML"):
            print("‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
        else:
            print("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞")
            return False
        
        print("\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
        return False


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."""
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
    print("=" * 60)
    
    # –¢–µ—Å—Ç 1: –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    if not test_telegram_connection():
        print("\n‚ùå –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω")
        return False
    
    # –¢–µ—Å—Ç 2: –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    if not test_message_sending():
        print("\n‚ùå –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –ø—Ä–æ–π–¥–µ–Ω")
        return False
    
    print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
    print("‚úÖ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    print("‚úÖ HTML-—Ä–∞–∑–º–µ—Ç–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ")
    print("‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è")
    
    return True


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
